// ã‚²ãƒ¼ãƒ ã®çŠ¶æ…‹ç®¡ç†
const game = {
    timer: 180,
    interval: null,
    score: 0,
    state: 'MENU', // MENU, LOCK, HOME, HACK, RESULT
    lockCode: "1995", // åˆæœŸã®ãƒ­ãƒƒã‚¯ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼ˆãƒ¢ãƒƒã‚¯ï¼‰
    lockInput: "",
    unlockedApps: [],
    currentApp: null,

    // ã‚¢ãƒ—ãƒªãƒ‡ãƒ¼ã‚¿ï¼ˆãƒ¢ãƒƒã‚¯ï¼‰
    apps: [
        { id: 'game1', name: 'ãƒ–ãƒ­ã‚¹ã‚¿', icon: 'ğŸ®', difficulty: 'low', points: 20, time: 20, pass: '1234' },
        { id: 'sns1', name: 'Instagram', icon: 'ğŸ“¸', difficulty: 'mid', points: 45, time: 35, pass: 'password' },
        { id: 'bank1', name: 'ã¿ãšã»éŠ€è¡Œ', icon: 'ğŸ¦', difficulty: 'high', points: 60, time: 60, pass: 'money2025' },
        { id: 'msg1', name: 'LINE', icon: 'ğŸ’¬', difficulty: 'mid', points: 45, time: 30, pass: 'love' },
    ],

    // åˆæœŸåŒ–
    init: function() {
        this.updateClock();
        setInterval(() => this.updateClock(), 60000);
    },

    updateClock: function() {
        const now = new Date();
        const timeStr = now.getHours().toString().padStart(2,'0') + ':' + now.getMinutes().toString().padStart(2,'0');
        document.getElementById('clock-display').innerText = timeStr;
    },

    // ç”»é¢åˆ‡ã‚Šæ›¿ãˆ
    switchScreen: function(screenId) {
        document.querySelectorAll('.screen').forEach(el => el.classList.remove('active'));
        document.getElementById(screenId).classList.add('active');
    },

    // ã‚·ãƒ³ã‚°ãƒ«ãƒ—ãƒ¬ã‚¤é–‹å§‹
    startSinglePlayer: function() {
        this.score = 0;
        this.timer = 180;
        this.unlockedApps = [];
        this.lockInput = "";
        
        this.switchScreen('screen-lock');
        this.startTimer();
        this.updateLockDisplay();
        
        // ãƒ­ãƒƒã‚¯ç”»é¢ã®ãƒ’ãƒ³ãƒˆåˆæœŸè¡¨ç¤ºï¼ˆãƒ¢ãƒƒã‚¯ï¼‰
        document.getElementById('lock-hint').innerText = "AI: ã“ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯1990å¹´ä»£ç”Ÿã¾ã‚Œã®ã‚ˆã†ã§ã™...";
    },

    startTimer: function() {
        if(this.interval) clearInterval(this.interval);
        this.interval = setInterval(() => {
            this.timer--;
            document.getElementById('game-timer').innerText = this.timer;
            
            // æ™‚é–“çµŒéã«ã‚ˆã‚‹ãƒ’ãƒ³ãƒˆãªã©ã®ã‚¤ãƒ™ãƒ³ãƒˆã‚’ã“ã“ã«è¨˜è¿°
            
            if (this.timer <= 0) {
                this.endGame();
            }
        }, 1000);
    },

    // ãƒ­ãƒƒã‚¯ç”»é¢ãƒ­ã‚¸ãƒƒã‚¯
    inputLock: function(num) {
        if (this.lockInput.length < 4) {
            this.lockInput += num;
            this.updateLockDisplay();
        }
        if (this.lockInput.length === 4) {
            setTimeout(() => this.checkLock(), 300);
        }
    },

    clearLock: function() {
        this.lockInput = "";
        this.updateLockDisplay();
    },

    updateLockDisplay: function() {
        let display = "";
        for(let i=0; i<4; i++) {
            if (i < this.lockInput.length) display += "â— ";
            else display += "â—‹ ";
        }
        document.getElementById('lock-input-display').innerText = display;
    },

    checkLock: function() {
        if (this.lockInput === this.lockCode) {
            // ãƒ­ãƒƒã‚¯è§£é™¤æˆåŠŸ
            this.score += 30; // åŸºæœ¬ç‚¹
            // ãƒœãƒ¼ãƒŠã‚¹è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯ã¯ã“ã“ã«è¿½åŠ 
            this.updateScore();
            this.setupHomeScreen();
            this.switchScreen('screen-home');
        } else {
            // å¤±æ•—
            alert("ãƒ‘ã‚¹ã‚³ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™"); // å®Ÿéš›ã¯ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã«ã™ã‚‹
            this.lockInput = "";
            this.updateLockDisplay();
        }
    },

    // ãƒ›ãƒ¼ãƒ ç”»é¢æ§‹ç¯‰
    setupHomeScreen: function() {
        const grid = document.getElementById('app-grid');
        grid.innerHTML = "";
        this.apps.forEach(app => {
            const isHacked = this.unlockedApps.includes(app.id);
            const el = document.createElement('div');
            el.className = 'app-icon';
            el.innerHTML = `
                <div class="icon-img ${isHacked ? 'hacked' : ''}">${app.icon}</div>
                <div class="app-name">${app.name}</div>
            `;
            if (!isHacked) {
                el.onclick = () => this.openAppHack(app);
            }
            grid.appendChild(el);
        });
    },

    // ã‚¢ãƒ—ãƒªè§£èª­ç”»é¢
    openAppHack: function(app) {
        this.currentApp = app;
        this.switchScreen('screen-hack');
        document.getElementById('hack-target-name').innerText = app.name;
        document.getElementById('hack-target-icon').innerText = app.icon;
        document.getElementById('hack-input').value = "";
        document.getElementById('hack-logs').innerHTML = "> æ¥ç¶šç¢ºç«‹...<br>> è§£æé–‹å§‹...";
        document.getElementById('hack-hint-text').innerText = "AI: ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’åˆ†æä¸­...";
    },

    returnToHome: function() {
        this.currentApp = null;
        this.switchScreen('screen-home');
    },

    submitHack: function() {
        const input = document.getElementById('hack-input').value;
        if (input === this.currentApp.pass) {
            // æ­£è§£
            this.score += this.currentApp.points;
            this.unlockedApps.push(this.currentApp.id);
            this.updateScore();
            this.setupHomeScreen(); // ã‚¢ã‚¤ã‚³ãƒ³çŠ¶æ…‹æ›´æ–°
            this.returnToHome();
        } else {
            alert("ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™");
            document.getElementById('hack-logs').innerHTML += "<br>> <span style='color:red'>èªè¨¼å¤±æ•—</span>";
        }
    },

    updateScore: function() {
        document.getElementById('current-score').innerText = `Score: ${this.score}`;
    },

    // ã‚²ãƒ¼ãƒ çµ‚äº†
    endGame: function() {
        clearInterval(this.interval);
        this.switchScreen('screen-result');
        document.getElementById('final-score').innerText = this.score;
        
        // æ‚ªç”¨ã‚¹ãƒˆãƒ¼ãƒªãƒ¼è¡¨ç¤ºï¼ˆãƒ¢ãƒƒã‚¯ï¼‰
        let story = "ã‚ãªãŸã®æƒ…å ±ã¯å®ˆã‚‰ã‚Œã¾ã—ãŸ... ã¨è¨€ã„ãŸã„ã¨ã“ã‚ã§ã™ãŒã€";
        if (this.unlockedApps.length > 0) {
            story += `${this.unlockedApps.length}ã¤ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãŒä¾µå®³ã•ã‚Œã¾ã—ãŸã€‚\n`;
            story += "SNSã‚¢ã‚«ã‚¦ãƒ³ãƒˆãŒä¹—ã£å–ã‚‰ã‚Œã€å‹äººã«ã‚¹ãƒ‘ãƒ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒé€ä¿¡ã•ã‚Œã¾ã—ãŸã€‚";
        } else {
            story = "æ™‚é–“åˆ‡ã‚Œã«ã‚ˆã‚Šã€å®Œå…¨ãªä¾µå…¥ã¯é˜²ãŒã‚Œã¾ã—ãŸãŒã€ã‚¹ãƒãƒ›ã®ãƒ­ãƒƒã‚¯ã¯è§£é™¤ã•ã‚Œã¾ã—ãŸã€‚";
        }
        document.getElementById('story-text').innerText = story;
    },
};

// ã‚²ãƒ¼ãƒ åˆæœŸåŒ–
window.onload = () => game.init();
